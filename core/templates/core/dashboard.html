{% extends "core/base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dashboard-container mx-auto max-w-5xl">

    <h1 class="text-3xl font-bold mb-2">Welcome, {{ user.userprofile.full_name }}</h1>
    <p class="text-gray-600 mb-6">Your personalized burnout & astrological insight hub.</p>

    <!-- Add Button -->
    <button id="openBiometricModal" class="button-small mb-6">+ Add Biometric Data</button>

    <!-- GRID -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Burnout Gauge -->
        <div class="card p-6 shadow-md bg-white rounded-lg">
            <h2 class="text-xl font-semibold mb-3">Burnout Risk</h2>
            <canvas id="burnoutGauge"></canvas>
            <p class="text-center text-lg mt-2 font-medium">{{ combined_risk }}%</p>
        </div>

        <!-- Biometrics -->
        <div class="card p-6 shadow-md bg-white rounded-lg">
            <h2 class="text-xl font-semibold mb-3">Latest Biometrics</h2>

            {% if latest_biometric %}
            <ul class="space-y-2">
                <li><strong>HRV:</strong> {{ latest_biometric.hrv_score }}</li>
                <li><strong>Sleep Hours:</strong> {{ latest_biometric.sleep_hours }}</li>
                <li><strong>Stress Level:</strong> {{ latest_biometric.stress_level }}</li>
                <li><strong>Activity:</strong> {{ latest_biometric.activity_level }}</li>
            </ul>
            {% else %}
            <p class="text-gray-500">No data available.</p>
            {% endif %}
        </div>

        <!-- AI Prediction -->
        <div class="card p-6 shadow-md bg-white rounded-lg">
            <h2 class="text-xl font-semibold mb-3">AI Insight Summary</h2>

            {% if latest_prediction %}
                <p><strong>Level:</strong> {{ latest_prediction.predicted_burnout_level }}</p>
                <p><strong>Score:</strong> {{ latest_prediction.prediction_burnout_risk|floatformat:2 }}</p>
                <p><strong>Factors:</strong> {{ latest_prediction.contributing_factors }}</p>
                <a href="{{ latest_prediction.meditation_link }}" class="button-small mt-2">Meditation Link</a>
            {% else %}
                <p class="text-gray-500">No AI predictions yet.</p>
            {% endif %}
        </div>

        <!-- Transits -->
        <div class="card p-6 shadow-md bg-white rounded-lg">
            <h2 class="text-xl font-semibold mb-3">Astrological Transits</h2>

            {% if transit_alerts %}
                <ul class="space-y-3">
                {% for t in transit_alerts %}
                    <li class="border p-3 rounded-md">
                        <strong>{{ t.transit_planet }}</strong> in House {{ t.natal_house }}
                        <span class="block text-sm text-indigo-600">{{ t.severity }}</span>
                        <p class="text-gray-600">{{ t.description }}</p>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-500">No active transits at this time.</p>
            {% endif %}
        </div>

    </div>

</div>

<!-- Chart Script -->
<script>
new Chart(document.getElementById("burnoutGauge").getContext("2d"), {
    type: "doughnut",
    data: {
        datasets: [{
            data: [{{ combined_risk }}, {{ risk_remaining }}],
            backgroundColor: ["#ff6d6d", "rgba(200,200,200,0.15)"],
            borderWidth: 0
        }]
    },
    options: {
        cutout: "30%",
        plugins: { legend: { display: false } }
    }
});
</script>

{% endblock %}
